name: Release Obsidian Plugin

on:
  release:
    types: [created, published]  # å½“åœ¨ GitHub ä¸Šåˆ›å»ºæˆ–å‘å¸ƒ Release æ—¶è§¦å‘
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run type checking
      run: npx tsc --noEmit

    - name: Build plugin
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: obsidian-github-stars-manager-build
        path: |
          main.js
          manifest.json
          styles.css
          themes.css
          versions.json
        retention-days: 30

  test:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: obsidian-github-stars-manager-build

    - name: Verify build files exist
      run: |
        echo "ğŸ” Verifying build files..."
        test -f main.js && echo "âœ… main.js exists" || (echo "âŒ main.js missing" && exit 1)
        test -f manifest.json && echo "âœ… manifest.json exists" || (echo "âŒ manifest.json missing" && exit 1)
        test -f styles.css && echo "âœ… styles.css exists" || (echo "âŒ styles.css missing" && exit 1)
        test -f themes.css && echo "âœ… themes.css exists" || (echo "âŒ themes.css missing" && exit 1)
        test -f versions.json && echo "âœ… versions.json exists" || (echo "âŒ versions.json missing" && exit 1)
        echo "ğŸ‰ All required files are present!"

  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Validate manifest.json
      run: |
        echo "ğŸ“‹ Validating manifest.json..."
        node -e "
          const manifest = require('./manifest.json');
          console.log('ğŸ” Checking manifest.json structure...');

          // Check required fields
          const required = ['id', 'name', 'version', 'minAppVersion', 'description', 'author', 'authorUrl'];
          let hasError = false;

          for (const field of required) {
            if (!manifest[field] || (typeof manifest[field] === 'string' && manifest[field].trim() === '')) {
              console.error('âŒ Missing or empty required field: ' + field);
              hasError = true;
            } else {
              console.log('âœ… ' + field + ': ' + manifest[field]);
            }
          }

          // Check version format
          if (!/^[0-9]+\\.[0-9]+\\.[0-9]+$/.test(manifest.version)) {
            console.error('âŒ Version must be in format x.y.z, got: ' + manifest.version);
            hasError = true;
          }

          if (hasError) {
            console.log('');
            console.log('ğŸ’¡ Please ensure all required fields are properly filled in manifest.json');
            process.exit(1);
          }

          console.log('');
          console.log('ğŸ‰ manifest.json validation passed!');
          console.log('ğŸ“¦ Plugin: ' + manifest.name + ' v' + manifest.version);
          console.log('ğŸ‘¤ Author: ' + manifest.author + ' (' + manifest.authorUrl + ')');
        "

    - name: Validate versions.json
      run: |
        echo "ğŸ“‹ Validating versions.json..."
        node -e "
          const versions = require('./versions.json');
          const manifest = require('./manifest.json');

          console.log('ğŸ” Checking versions.json structure...');

          // Check if current version is in versions.json
          if (!versions[manifest.version]) {
            console.error('âŒ Current version ' + manifest.version + ' not found in versions.json');
            console.log('');
            console.log('ğŸ’¡ Run: npm version [patch|minor|major] to update version files');
            process.exit(1);
          }

          console.log('âœ… Current version ' + manifest.version + ' found in versions.json');
          console.log('ğŸ“± Minimum Obsidian version: ' + versions[manifest.version]);
          console.log('');
          console.log('ğŸ‰ versions.json validation passed!');
        "

  release:
    runs-on: ubuntu-latest
    needs: [build, test, validate]
    if: github.event_name == 'release'
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: obsidian-github-stars-manager-build

    - name: Create release archive
      run: |
        echo "ğŸ“¦ Creating release archive..."
        zip -r obsidian-github-stars-manager.zip main.js manifest.json styles.css themes.css versions.json
        ls -lh obsidian-github-stars-manager.zip

    - name: Upload release assets
      uses: softprops/action-gh-release@v2
      with:
        files: |
          main.js
          manifest.json
          styles.css
          themes.css
          versions.json
          obsidian-github-stars-manager.zip
        draft: false
        prerelease: false
        generate_release_notes: true
        fail_on_unmatched_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Release summary
      run: |
        echo "ğŸ‰ Release completed successfully!"
        echo "ğŸ“¦ Files uploaded:"
        echo "  - main.js"
        echo "  - manifest.json"
        echo "  - styles.css"
        echo "  - themes.css"
        echo "  - versions.json"
        echo "  - obsidian-github-stars-manager.zip"
        echo ""
        echo "âœ¨ Release Notes automatically generated from commit history"
